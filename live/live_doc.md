# **网络部直播文档**

Update 20181228

[TOC]



## 人员配备

- 三人及三人以上,一人主推,一人监测直播状况,一人机动

- 大型直播强烈建议,有部长或者人赢部门的大佬在场(一或 一以上)!!!或是经验极其丰富的部员

***

## 准备阶段

### 直播前准备(软硬件)

1. 安装必要的驱动及直播软件(详见直播群,群文件)

- 采集卡驱动[点此下载](https://www.yuan.com.tw/download/driver/ub530-series-driver.zip)
- OBS[官网在此](https://obsproject.com/)

2.准备必要的器材,一般所有的器材都统一放在一个大包(绿色,拉链坏了,要小心)中,包平时放在诊所或3-314保管)

- 网线(带线轴,也可能同时还有无线轴的备用网线)
- 剪刀胶带(线路过长时应当固定,以免被人群踢断电源或者网线)
- 视频信号采集卡及连接线(黑色盒状,USB3.0,可接收HDMI和SDI信号,切换方法见下)
- 插板(2+个)
- HDMI线(很长,平时卷起来)
- 信号源的连接线一般由负责信号源的一方提供.
- 其他选带项目
  - 路由器1-2台(用来保证网路的稳定)
  - 过线桥(应对线路经过人流密集区域的情况)
  - 网线连通性测试工具(没用过)

3.准备推流及监视设备(两台或以上笔记本)

- 用于进行视频流的推流;
- 检查服务器状态以及视频流的流量是否正常;
- 检测播放页面上的直播是否正常进行;观察画质、流畅度等是否符合要求;及时向推流设备或信号源反应情况.

### OBS调试工作

1. 串流(右下角->设置->流)
   - 服务器URL:
   - 当前主要服务器:rtmp://live.bitnp.net:1935/nplive
   - ipv4地址rtmp://10.1.139.100:1935/nplive ipv6地址rtmp://[2001:da8:204:2a05::100]:1935/nplive
   - 精工书院学科素养:rtmp://jgsy.bitnp.net:1935/nplive
   - 流密钥:livestream(都是介个)(URL下面的行,填进去会黑点显示(有可能叫流名称)

2. 输出(右下角->设置->输出)
   - 视频比特率 网络不好时:2500kb/s左右,网络状况好时:5000-8000kb/s
   - 4G网络很不稳,建议1500kb/s左右,如有必要,可以继续下调,注意这时候要把输出分辨率跳到1280*720.如果低于1000kb/s,可以考虑直接放弃直播.
   - 编码器 QSV(Intel核显硬件编码)或AMD
   - 也可以用x264软压,费CPU
   - 尽量避免NVENC
3. 视频(右下角->设置->视频)
   - 基础分辨率 1080p(1920*1080)
   - 输出分辨率 1080p(1920*1080)
   - ~~缩放过滤器 双直线法~~(我没用过)
   - fps 30 **(直播不是游戏,30帧足够,60帧可能会翻车,理论上25帧也行)**
   - ~~禁用Aero(win 10无此选项,可以不用设置)~~

4. 添加视频捕获设备

   - 来源->右键->添加->视频捕获设备->确定,设备选择采集卡(应该是那个驱动的名称),最下面打勾"使用自定义的音频设备",音频设备选择"",确认
   - 混音器->视频捕获设备->高级音频属性->视频捕获设备打勾"下降混合到单声道"(如果想要让OBS把声音输出到扬声器或耳机可以在音频监听选择"监听并输出")
   - 来源->视频捕获设备->右键->去隔行扫描-> Yadif 2x

### 每次直播前

1. 提前测试好所有直播设备和服务器相关配置
   - 测试完成后,原则上,除了远程推流地址,其他设置均不再改动
2. 涉及摄像机问题,请尽快解决
   - 负责人提前联系摄像负责人(学习/学电/记者团),协调输入信号.
   - 询问输入方式,确定我们推流机器的位置.
   - 有条件时(一般是军理课),可以提前测试输入信号.
3. 准备好所需要的器材.(如有必要,可以提前布线)

***

## 直播具体操作

### 播前: 踩点

1. 找到属于自己的直播位置,并在直播位置附近寻找好电源进行连接;
2. 找到直播位置附近可用的网络端口并检查其是否可用以及是否稳定;
3. 预估在直播地点布线的难度和工作量;
4. 检查器材能否正常使用并且保持稳定;
5. 检查设备上的采集卡驱动是否已经成功安装并且采集卡是否能正常工作(此时采集卡指示灯为红色);
6. 检测设备是否能在推流与监控的情况下稳定高效的运行,排除由于设备的不稳定性所造成的直播的中断或者卡顿以及无法正确调试等问题.

### 当天:(根据预估情况,提前足够的时间到场)

1. 首先布线,布置电源线以及网线,测试电源稳定后运行设备,测试网络情况,布置1~2台路由器并其测试网络状况. ***(注意！必须检测路由器网络是否稳定可用！)***

2. 上述工作完成后,由技术人员首先检查推流服务器的状况,检查必要配置,并确保使用的校网账号的余额是充足的(尤其在向外网推流时必须检查).

3. 连接采集卡,并且与信号源进行连接.在OBS上进行相关的配置,选择最稳定的设备推流,保证流的稳定.

   **PS:** 信号源的不稳定要及时反应并且和信号的提供者进行沟通,尽快解决.

4. 进行尝试性的推流,在nplive/bilibili上观看直播,确定直播的音视频能否正常播放,是否出现卡顿的情况.若有,适当调节OBS中的设置(详见前述部分).

***

## 布线规则

1. 网线和光纤采用**两条**各自适合的线路,并且用**绝缘胶带**将线路尽量固定在**墙角**,因为光纤比较脆弱,还可以使用网线保护光纤的方法,当然如果没有使用光纤就直接布网线就可以了.

2. 尽量走直线,并选择人流较少的地方走线.

3. 对于人群踩踏较多的地方,比如门口,道路的位置适当利用过线桥进行加固,

4. 可以从墙上过线绕过门口可以从墙上绕过去.

   **经实践检验,黄黑相间的绝缘胶带绝对是好帮手. 另外应该更加注意提前对风险做好应对方案,到现场再现想解决方案风险较大.**

***

## 服务器SSH操作（推非网协直播页面必看）

- **首先，提前一小时左右打开直播间开始推视频（无论什么东西，要确认直播间的通畅）**

- **live.bitnp.net**
  - **注意:这个仅仅在推b站时才可能需要操作这一部分,只推nplive不用管这里**
  - **这里需要熟悉docker的linux大佬ssh操作(血的教训)**

    $ ssh root@live.bitnp.net
    (Input password)
    # ls
    (可以看到 1080p.png ... nplive bash-tools nplive-deploy等)
    --> nplive: 前端,尽量不要改(大佬除外)
    --> bash-tools: 登录校园网账号的脚本在这里
    --> nplive-deploy: 直播系统的目录
    # cd bash-tools
    # ls
    # ./login.sh
    usage ./login.sh username [password]
    --> 向bilibili推流时需要在服务器用这个脚本登录校园网
    # cd ~
    # cd nplive-deploy
    # cd bitnp
    # ls
    (... bitnp.conf ...)
    --> bitnp.conf是配置文件,别的东西不要碰
    # nano bitnp.conf
    --> 编辑一下,也可以用vim
    --> 这里我们直接翻到文件的最后面engine output部分,这里是bilibili转发的配置,别处一般不用改
    --> 第一行配置enabled on;
    --> 如果原来是enabled off需要改成on,推流结束最好改回off
    --> 最后面形如output rtmp://bvc.live-send.acg.tv/live-bvc/?streamname=live......的配置
    --> 这是推流地址,需要把推流直播间bilibili给的链接填到这里
    # docker kill --signal=HUP [srs_docker_name]
    --> bilibili推流设置结束

- **jgsy.bitnp.net**
  - 连接服务器,重启nginx-rtmp(等待填坑)

***

## 应急处置方案

### 断网

- 一般正常直播情况下要保证两台机器同时连接不同的网络环境(一般是有线和无线)

- ~~当负责直播推流的机器断网后,首先需要连入服务器重启nginx-rtmp服务,然后第二台机器推送翻车图片(良好的用户体验)然后当网络恢复后,再用之前的机器进行后续推流.~~

- 大佬在live.bitnp.net部署了新的SRS直播系统,不需要进行上述重启操作;

- jgsy.bitnp.net是旧平台,需要进行上述操作

- 检查接口,电源,网线本身,路由设备及其他环节

### 其他设备故障（此部分仔细阅读）

例如:

- 突然碰掉了线.这个属于重大事故,一定要避免.

- 当设备出问题的时候，首先检查自身，过一遍之后，如果没有发现问题，那么请及时联系信号源，极有可能是他们的问题，不要一直往自己身上背锅。

***

## 其他注意事项

- 对于部分笔记本电脑,如若出现成功安装驱动,但接上采集卡后未能识别采集卡.可查看接口是不是有问题.具体操作:*右键点击开始菜单->设备管理器->声音、视频和游戏控制器->找到与驱动名称一致的硬件*,之后查看是否出现问题,按提示进行具体操作.例如笔者当时是数字签名出现问题,解决方案是从设置里的恢复菜单进行重启以更改固件,将强制数字签名程序禁用之后,设备即可正常工作.
- 采集卡正常工作时,指示灯为红色;未安装正确驱动时,指示灯为黄色;~~接口接触不良没连上,指示灯不亮(废话)~~
- **推B站直播,在设置的时候,记得时常刷新开播管理界面,当一段时间没有推内容的时候,bilibili会自动关闭直播,一定要检查,也就是说修改服务器配置开始推流一定要快(所以需要大佬操作)!!!!**
- **遇到问题不要总想着是不是自己的问题,因为极有可能时直播信号源的问题!!!!!!!!**
- 有时先连采集卡后开OBS会有玄学问题